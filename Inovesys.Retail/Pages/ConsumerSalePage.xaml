<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Inovesys.Retail.Models"
             x:Class="Inovesys.Retail.Pages.ConsumerSalePage"
             xmlns:zoft="http://zoft.MauiExtensions/Controls">

    <ContentPage.MenuBarItems>
        <MenuBarItem Text="Venda Consumidor">

            <MenuFlyoutItem x:Name="miCancelarItem"
                    Text="Cancelar produto"
                    Clicked="OnCancelItemClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F2" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>

            <MenuFlyoutItem x:Name="miEditQu"
                       Text="Editar Quantidade"
                       Clicked="OnEditQuant">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F3" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>

            <MenuFlyoutItem x:Name="btnOnPrinterClicked"
                     Text="Reimprimir"
                     Clicked="OnPrinterClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F4" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>

            <MenuFlyoutItem x:Name="miFinalizar"
                        Text="Finalizar venda"
                        Clicked="OnFinalizeSaleClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F6" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>

            <MenuFlyoutItem x:Name="miCancelar"
              Text="Cancela venda"
                    Clicked="OnCancelSaleClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F8" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>
            <MenuFlyoutItem x:Name="btnOnCancelInvoiceClicked"
                Text="Cancelar Cupom"
                        Clicked="OnCancelInoviceClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F9" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>
        </MenuBarItem>
    </ContentPage.MenuBarItems>

    <!-- ====== ESTILOS / RECURSOS ====== -->
    <ContentPage.Resources>
        <!-- Botões responsivos: 2 por linha (48%), crescem igualmente -->
        <Style x:Key="FlexButton" TargetType="Button">
            <Setter Property="Margin" Value="6" />
            <Setter Property="HeightRequest" Value="48" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="FlexLayout.Grow" Value="1" />
            <Setter Property="FlexLayout.Basis" Value="48%" />
            <Setter Property="HorizontalOptions" Value="Fill" />
        </Style>
    </ContentPage.Resources>

    <!-- ====== CONTAINER ====== -->
    <Grid Padding="10"
          RowSpacing="10"
          ColumnDefinitions="*,*,*">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="7*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Entry Grid.Row="0" Grid.Column="0"        
            x:Name="entryCustomerCpf"
            Grid.ColumnSpan="3"
            Placeholder="CPF do consumidor"
            Keyboard="Numeric"
            MaxLength="14"
            Unfocused="OnCpfUnfocused"
            Completed="OnCpfCompleted"
            HorizontalOptions="Center"/>

        <Grid Grid.Row="1" Grid.Column="0"
              ColumnSpacing="0"
              Grid.ColumnSpan="3"
              ColumnDefinitions="4*,80"
              RowDefinitions="Auto,6*,*,Auto">
            <!-- segunda coluna fixa 80px -->

            <!-- coluna 0: campo + lista -->
            <VerticalStackLayout Grid.Column="0" 
                                 Grid.Row="0"
                                 Spacing="0" 
                                 VerticalOptions="Start">

                <Entry x:Name="entryProductCode"
                           Placeholder="Digite o nome do produto..."
                           TextChanged="OnSearchTextChanged"
                           Completed="OnProductCodeEntered"
                           Margin="4,0" />

            </VerticalStackLayout>

            <!-- coluna 1: entry quantidade alinhado ao topo -->
            <StackLayout Grid.Row="0"
                         Grid.Column="1"
                         VerticalOptions="Start"
                         HorizontalOptions="Center"
                         Padding="0">

                <Entry x:Name="entryQuantity"
                   Text="1"
                   Keyboard="Numeric"
                   HorizontalTextAlignment="Center"
                   Completed="OnProductCodeEntered"
                   HeightRequest="40"
                   WidthRequest="70"
                   VerticalOptions="Start" />

            </StackLayout>

            <!-- 3) LISTA DE ITENS -->

            <CollectionView Grid.Row="1"
                            Grid.ColumnSpan="3"
                            Margin="0,10,0,0" 
                            x:Name="ItemsListView"
                            SelectionMode="Single"
                            ItemsLayout="VerticalList"
                            HorizontalOptions="Fill"
                            VerticalOptions="Fill"
                            VerticalScrollBarVisibility="Always"
                            ItemsUpdatingScrollMode="KeepLastItemInView">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ConsumerSaleItem">
                        <Border  StrokeThickness="2"
                                 Stroke="#90A4AE"
                                 StrokeShape="RoundRectangle 15"
                                 BackgroundColor="#0D47A1"
                                 Padding="5"
                                 Margin="0">
                            <Grid Padding="4"
                                  ColumnSpacing="5"
                                  RowSpacing="0"
                                  ColumnDefinitions="Auto,3*,Auto,Auto,1*">
                                <!-- ID -->
                                <Label Grid.Column="0"
                                       Text="{Binding Id, StringFormat='{}{0:D4}'}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center" />
                                <!-- DESCRIÇÃO -->
                                <Label Grid.Column="1"
                                       Text="{Binding Description}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       VerticalOptions="Center" />
                                <!-- PREÇO UNITÁRIO -->
                                <Label Grid.Column="2"
                                       Text="{Binding Price, StringFormat='R$ {0:F2}'}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"
                                       VerticalOptions="Center" />
                                <!-- QUANTIDADE (EDITÁVEL) -->
                                <Entry Grid.Column="3"
                                       Margin="20,0,0,0"
                                       AutomationId="QtyEntry"
                                       Text="{Binding Quantity, Mode=TwoWay, StringFormat='{0:N2}'}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       HeightRequest="15"
                                       WidthRequest="60"
                                       Keyboard="Numeric"
                                       TextColor="White"
                                       BackgroundColor="#1E88E5"
                                       HorizontalTextAlignment="Center"
                                       VerticalOptions="End"
                                       HorizontalOptions="End"
                                       Completed="Entry_Completed" />
                                <!-- TOTAL -->
                                <Label Grid.Column="4"
                                       Text="{Binding Total, StringFormat='R$ {0:F2}'}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalTextAlignment="End"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />

                            </Grid>

                        </Border>

                    </DataTemplate>
                </CollectionView.ItemTemplate>

            </CollectionView>

            <CollectionView x:Name="suggestionList" Grid.Row="1"  Grid.ColumnSpan="3"
                    IsVisible="False"
                    SelectionMode="Single"
                    HorizontalOptions="Fill"
                    VerticalOptions="Start"
                    BackgroundColor="White"
                    Margin="0,10,0,0"        
                    VisualElement.ZIndex="100">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <!-- dê um x:Name ao Border se quiser usar TargetName nos Setters -->
                        <Border x:Name="itemBorder"
                                StrokeThickness="0"
                                Padding="0"
                                Background="Transparent"
                                StrokeShape="RoundRectangle 10">


                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSuggestionTapped" />
                            </Border.GestureRecognizers>

                            <!-- VisualStateManager no elemento raiz do template -->
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal" />
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <!-- seta o Background do próprio Border -->
                                            <Setter Property="Background" Value="#FFFFE0" />

                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>

                            <Grid Padding="8" ColumnDefinitions="2*,5*,2*">
                                <Label  x:Name="lblId" Grid.Column="0" Text="{Binding Id}" />
                                <Label  x:Name="lblName" Grid.Column="1" Text="{Binding Name}" />
                                <Label  x:Name="lblPrice" Grid.Column="2" Text="{Binding Price, StringFormat='R$ {0:N2}'}"
                               HorizontalTextAlignment="Center" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <StackLayout Grid.Row="2" Grid.Column="0" 
                     HorizontalOptions="End" 
                     VerticalOptions="Center"
                     Grid.ColumnSpan="4" >
            <Label x:Name="lblTotal"
                      Text="Total: R$ 0,00"
                      FontSize="32"
                      FontAttributes="Bold"
                      HorizontalOptions="End"
                      VerticalOptions="End"
                      Margin="0,0,0,0" />
        </StackLayout>

        <StackLayout Grid.Row="3"  Grid.Column="0" 
                     HorizontalOptions="Center" 
                     Grid.ColumnSpan="3">
            <Label 
                    Grid.Column="0"
                    Grid.ColumnSpan="3"
                    Text="(F2) Cancelar item   (F3) Alterar quantidade   (F4) Reimprimir   (F6) Finalizar venda   (F8) Cancelar venda   (F9) Cancelar cupom"
                    FontSize="12"
                    Margin="0,0,0,0"
                    VerticalOptions="Center"/>
            <Grid 
                  Grid.ColumnSpan="4"
                  Margin="0,0,0,0"
                  ColumnDefinitions="*,*,*"
                    RowDefinitions="*,*"
                  VerticalOptions="Center">

                <Button Grid.Column="0" Style="{StaticResource FlexButton}" Text="Canc. Venda" BackgroundColor="Red" TextColor="White" Clicked="OnCancelSaleClicked">
                    <Button.Shadow>
                        <Shadow Brush="#80000000"
                             Offset="2,4"
                             Radius="8"
                             Opacity="0.6" />   
                    </Button.Shadow>
                </Button>
                <Button Grid.Column="1" Style="{StaticResource FlexButton}" Text="Canc. Item"  BackgroundColor="Yellow" TextColor="Black" Clicked="OnCancelItemClicked">
                    <Button.Shadow>
                        <Shadow Brush="#80000000"
                             Offset="2,4"
                             Radius="8"
                             Opacity="0.45" />   
                    </Button.Shadow>
                </Button>


                <Button Grid.Column="2" Style="{StaticResource FlexButton}" Text="Finalizar" BackgroundColor="Green" TextColor="White" Clicked="OnFinalizeSaleClicked">
                    <Button.Shadow>
                        <Shadow Brush="#80000000"
                            Offset="2,4"
                            Radius="8"
                            Opacity="0.6" />    
                    </Button.Shadow>

                </Button>
                <Button Grid.Column="0" Grid.Row="1"  Style="{StaticResource FlexButton}" Text="Reimprimir" BackgroundColor="Blue" TextColor="White"  Clicked="OnPrinterClicked">
                    <Button.Shadow>
                        <Shadow Brush="#80000000"
                         Offset="2,4"
                         Radius="8"
                         Opacity="0.6" />   
                    </Button.Shadow>
                </Button>
                <Button Grid.Column="1" Grid.Row="1"  Style="{StaticResource FlexButton}" Text="Canc.Cupom" BackgroundColor="OrangeRed" TextColor="White"  Clicked="OnCancelInoviceClicked" >
                    <Button.Shadow>
                        <Shadow Brush="#80000000"
                         Offset="2,4"
                         Radius="8"
                         Opacity="0.6" />
                    </Button.Shadow>
                </Button>

            </Grid>

            <Grid Grid.ColumnSpan="3" Margin="0,0,0,0" ColumnDefinitions="*,*,*" VerticalOptions="Center">

                <!--<Button x:Name="btnPrint" 
                        Grid.Column="1"  
                        Style="{StaticResource FlexButton}" Text="Imprimir" BackgroundColor="Violet" TextColor="White" 
                        Clicked="" />-->
            </Grid>

        </StackLayout>

        <Grid Grid.Row="0"
              Grid.RowSpan="99" 
              Grid.Column="0"
              Grid.ColumnSpan="99"
              IsVisible="{Binding IsWorking}"
              BackgroundColor="#66000000"
              ZIndex="999"
              InputTransparent="False"
              VerticalOptions="Fill"
              HorizontalOptions="Fill">

            <VerticalStackLayout VerticalOptions="Center"
                             HorizontalOptions="Center"
                             Spacing="12"
                             Padding="20">
                <ActivityIndicator IsRunning="True"
                               WidthRequest="56"
                               HeightRequest="56"/>
                <Label Text="{Binding BusyText}"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="White"
                   HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
