<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Inovesys.Retail.Models"
             x:Class="Inovesys.Retail.Pages.ConsumerSalePage"
             xmlns:zoft="http://zoft.MauiExtensions/Controls">

    <ContentPage.MenuBarItems>
        <MenuBarItem Text="Venda Consumidor">

            <MenuFlyoutItem x:Name="miCancelarItem"
                    Text="Cancelar produto (F2)"
                    Clicked="OnCancelItemClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F2" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>

            <MenuFlyoutItem x:Name="miEditQu"
                       Text="Editar Quantidade(F3)"
                       Clicked="OnEditQuant">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F3" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>


            <MenuFlyoutItem x:Name="miFinalizar"
                        Text="Finalizar venda (F6)"
                        Clicked="OnFinalizeSaleClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F6" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>

            <MenuFlyoutItem x:Name="miCancelar"
              Text="Cancela venda (F8)"
              Clicked="OnCancelSaleClicked">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F8" />
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>

           
        </MenuBarItem>
    </ContentPage.MenuBarItems>

    <!-- ====== ESTILOS / RECURSOS ====== -->
    <ContentPage.Resources>
        <!-- Botões responsivos: 2 por linha (48%), crescem igualmente -->
        <Style x:Key="FlexButton" TargetType="Button">
            <Setter Property="Margin" Value="6" />
            <Setter Property="HeightRequest" Value="48" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="FlexLayout.Grow" Value="1" />
            <Setter Property="FlexLayout.Basis" Value="48%" />
            <Setter Property="HorizontalOptions" Value="Fill" />
        </Style>
    </ContentPage.Resources>

    <!-- ====== CONTAINER ====== -->
    <Grid Padding="10"
          RowSpacing="16"
          ColumnDefinitions="*,*,*">

        <!-- 0: Total | 1: CPF+Cadastrar | 2: Código+Qtd | 3: Lista | 4: Ações | 5: Venda -->
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <!-- 0: Total -->
            <RowDefinition Height="Auto" />
            <!-- 1: CPF + Cadastrar -->
            <RowDefinition Height="Auto" />
            <!-- 2: Código + Quantidade -->
            <RowDefinition Height="*"    />
            <!-- 3: Lista -->
            <RowDefinition Height="Auto" />
            <!-- 4: Botões Ações -->
            <RowDefinition Height="Auto" />
            <!-- 5: Botões Venda -->
        </Grid.RowDefinitions>


        <Entry x:Name="entryCustomerCpf"
                       Grid.Column="0"
                       Grid.Row="0"
                       Grid.ColumnSpan="3"
                       Placeholder="CPF do consumidor"
                       Keyboard="Numeric"
                       MaxLength="14"
                       Unfocused="OnCpfUnfocused"
                       Completed="OnCpfCompleted"
                       HorizontalOptions="Center"
                       MaximumWidthRequest="300"/>

        <!--<Button Grid.Column="1"
                    Text="CADASTRO"
                    BackgroundColor="DodgerBlue"
                    TextColor="White"
                    Padding="12,6"
                        IsVisible="False"
                    Clicked="OnCadastrarClienteClicked" />-->

        <!-- ====== (2) CÓDIGO + QUANTIDADE ====== -->
        <Grid Grid.Row="2"
              ColumnSpacing="0"
              Grid.ColumnSpan="3"
              ColumnDefinitions="4*,*">

            <zoft:AutoCompleteEntry
                    Grid.Column="0"
                    x:Name="entryProductCode"
                    Placeholder="Código do produto ou descrição"
                    Text="{Binding ProductText, Mode=TwoWay}"
                    ItemsSource="{Binding ProductSuggestions}"
                    DisplayMemberPath="Display"
                                
                    TextMemberPath="Id"
                    Completed="OnProductCodeEntered"/>

            <Entry x:Name="entryQuantity"
                    Grid.Column="1"
                    Text="1"
                    Keyboard="Numeric"
                    HorizontalTextAlignment="Center"
                    Completed="OnProductCodeEntered"
                    Focused="OnQuantityFocused" />


        </Grid>

        <!-- 3) LISTA DE ITENS -->

        <Grid Grid.Column="0"
              Grid.Row="3"
              Grid.ColumnSpan="3"
              Padding="8"
              HorizontalOptions="Fill"
              VerticalOptions="Fill"
              RowDefinitions="*">

            <CollectionView
                    x:Name="ItemsListView"
                    SelectionMode="Single"
                    ItemsLayout="VerticalList"
                    HorizontalOptions="Fill"
                    VerticalOptions="Fill"
                    VerticalScrollBarVisibility="Always"
                    ItemsUpdatingScrollMode="KeepLastItemInView">

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ConsumerSaleItem">
                        <Border  StrokeThickness="2" Stroke="#90A4AE" StrokeShape="RoundRectangle 10" HeightRequest="70"
                                 BackgroundColor="#007bff" 
                                 Padding="4" Margin="2">

                            <Grid Padding="8" ColumnSpacing="8" ColumnDefinitions="*,3*,*,*,*"  RowSpacing="10" VerticalOptions="Center">
                                <Label 
                                    
                                        TextColor="White"
                                        Grid.Column="0"
                                        FontSize="12"
                                        VerticalOptions="Center"
                                        Text="{Binding Id, StringFormat='{}{0:D4}'}" />
                                <Label TextColor="White" Grid.Column="1" Text="{Binding Description}" FontSize="12" VerticalOptions="Center"/>
                                <!--<Label TextColor="White" Grid.Column="1" Text="{Binding Quantity, StringFormat='{0:N0}'}" FontSize="16" HorizontalTextAlignment="End" VerticalOptions="Center"/>-->
                                <!-- Quantidade editável -->

                                <Label TextColor="White" Grid.Column="2" Text="{Binding Price, StringFormat='R$ {0:F2}'}" FontSize="12" HorizontalTextAlignment="End" VerticalOptions="Center"/>
                                <Entry
                                                AutomationId = "QtyEntry"            
                                                Grid.Column="3"
                                                Text="{Binding Quantity, Mode=TwoWay, StringFormat='{0:N0}'}"
                                                FontSize="12"
                                                HeightRequest="28"
                                                Margin="0"
                                                Keyboard="Numeric"
                                                HorizontalTextAlignment="Center"
                                                VerticalOptions="Center"
                                                TextColor="White"
                                                BackgroundColor="#1E88E5"
                                                WidthRequest="40"
                                                HorizontalOptions="Center"
                                    Completed="Entry_Completed"/>

                                <Label TextColor="White" Grid.Column="4" Text="{Binding Total, StringFormat='R$ {0:F2}'}" FontSize="12" HorizontalTextAlignment="End" VerticalOptions="Center"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- ====== (0) TOTAL ====== -->
        <Label x:Name="lblTotal"
             Grid.Row="4"
             Grid.Column="0"
             Text="Total: R$ 0,00"
             FontSize="28"
             FontAttributes="Bold"
             HorizontalOptions="End"
             VerticalOptions="End"
             Grid.ColumnSpan="3"      
             Margin="0,0,0,6" />


        <Grid Grid.Row="5" 
              Grid.ColumnSpan="3"
              Margin="0,4,0,0"
              ColumnDefinitions="*,*,*">

            <Button Grid.Column="0" Style="{StaticResource FlexButton}" Text="Cancelar Venda (F8)" BackgroundColor="Red" TextColor="White" Clicked="OnCancelSaleClicked" />
            <Button Grid.Column="1" Style="{StaticResource FlexButton}" Text="Cancelar Item (F2)" BackgroundColor="Yellow" TextColor="Black" Clicked="OnCancelItemClicked" />
            <Button Grid.Column="2" Style="{StaticResource FlexButton}" Text="Finalizar venda (F6)" BackgroundColor="Green" TextColor="White" Clicked="OnFinalizeSaleClicked" />
                        
            
        </Grid>




        <!-- suas RowDefinitions e todo o conteúdo da tela -->

        <!-- ===== OVERLAY DE BUSY ===== -->
        <Grid Grid.Row="0"
              Grid.Column="0"
              Grid.RowSpan="6"
              Grid.ColumnSpan="3"
              IsVisible="{Binding IsWorking}"
              BackgroundColor="#66000000"
              ZIndex="999"
              InputTransparent="False">

            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="12" Padding="20">
                <ActivityIndicator IsRunning="True" WidthRequest="56" HeightRequest="56"/>
                <Label Text="{Binding Source={x:Reference PageRoot}, Path=BusyText, FallbackValue='Finalizando venda...'}"
                       FontSize="18" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Grid>


    </Grid>
</ContentPage>
